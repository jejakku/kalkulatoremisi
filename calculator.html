<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JejakKu - Kalkulator Emisi Karbon</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter dari Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* Terapkan font Inter ke seluruh elemen body dan pastikan tidak ada margin/padding default */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box; /* Pastikan padding dan border termasuk dalam total lebar/tinggi */
            transition: background-color 0.3s ease; /* Transisi untuk perubahan background body */
        }
        /* Styling tambahan untuk modal agar muncul di atas segalanya */
        .modal-overlay {
            z-index: 1000; /* Pastikan modal di atas elemen lain */
        }
        .modal-content {
            z-index: 1001; /* Pastikan konten modal di atas overlay */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div id="app-root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Fungsi render React-like sederhana untuk HTML
        function render(component) {
            const root = document.getElementById('app-root');
            if (root) {
                root.innerHTML = component;
                attachEventListeners(); // Panggil fungsi untuk melampirkan event listeners setelah rendering
            } else {
                console.error("Elemen 'app-root' tidak ditemukan.");
            }
        }

        // State management sederhana
        let electricityKWh = 0; // Masih dalam kWh bulanan, akan dikonversi ke harian
        let vehicleType = 'mobil';
        let transportKm = 0; // Jarak tempuh bulanan, akan dikonversi ke harian
        let wasteKg = 0; // Sampah mingguan, akan dikonversi ke harian
        let dietType = 'daging';
        let totalEmissions = 0; // Emisi harian
        let emissionBreakdown = {};
        let treesEquivalent = 0; // Trees equivalent will now represent annual trees
        // Diubah menjadi objek untuk menampung intro, items, dan outro
        let staticSuggestions = { intro: "", items: [], outro: "" };
        let showInfoModal = false;
        let showSuggestionsModal = false; // State baru untuk modal saran
        let isDarkMode = false; // State untuk mode gelap

        // Firebase states
        let db = null;
        let auth = null;
        let userId = null;
        let isAuthReady = false;

        // Emission factors (simplified and example values, in kg CO2e per unit)
        // These factors are illustrative and should be replaced with more precise, localized data for a real application.
        const EMISSION_FACTORS = {
            electricity: 0.5, // kg CO2e per kWh
            car: 0.18,        // kg CO2e per km
            motorcycle: 0.08, // kg CO2e per km
            publicTransport: 0.05, // kg CO2e per km
            waste: 0.5,       // kg CO2e per kg
            diet: {           // kg CO2e per bulan (rata-rata sederhana per kategori)
                daging: 250,    // Konsumsi daging tinggi
                vegetarian: 100, // Diet vegetarian
                vegan: 50       // Diet vegan
            }
        };

        // Faktor konversi untuk pohon: 1 pohon dewasa menyerap sekitar 21 kg CO2 per tahun
        const CO2_PER_TREE_PER_YEAR = 21; // kg CO2 per pohon per tahun
        // Konversi ke per hari (untuk informasi di UI)
        const CO2_PER_TREE_PER_DAY = CO2_PER_TREE_PER_YEAR / 365; // kg CO2 per pohon per hari

        // Fungsi untuk memainkan efek suara
        function playSound(soundFile) {
            const audio = new Audio(soundFile);
            audio.play().catch(e => console.error("Error playing sound:", e));
        }

        // Fungsi untuk mengontrol mode gelap/terang
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            localStorage.setItem('isDarkMode', isDarkMode); // Simpan state ke localStorage
            updateUI();
            playSound('sounds/toggle_click.mp3'); // Memainkan suara saat toggle
        }

        // Fungsi untuk menghasilkan saran statis berdasarkan rincian emisi
        const getStaticSuggestions = (breakdown) => {
            let intro = "Terima kasih telah menghitung jejak karbon Anda! Setiap langkah kecil yang Anda lakukan sangat berarti. Berikut adalah beberapa saran personalisasi untuk mengurangi dampak lingkungan Anda:";
            let items = [];
            let outro = "Mari bersama menciptakan Indonesia bebas emisi!";

            if (Object.keys(breakdown).length === 0 || totalEmissions === 0) {
                return { intro: "Hitung jejak karbon Anda untuk mendapatkan saran personalisasi!", items: [], outro: "" };
            }

            // Tambahkan saran untuk setiap kategori yang memiliki emisi > 0
            if (breakdown.listrik > 0) {
                items.push("Fokus pada penghematan listrik:");
                items.push("- Matikan lampu dan peralatan elektronik saat tidak digunakan.");
                items.push("- Cabut charger dan perangkat yang tidak digunakan (phantom load).");
                items.push("- Gunakan lampu LED yang hemat energi.");
                items.push("- Manfaatkan cahaya alami sebisa mungkin.");
                items.push("- Pertimbangkan untuk menggunakan peralatan elektronik hemat energi.");
            }

            if (breakdown.transportasi > 0) {
                items.push("Fokus pada pengurangan emisi transportasi:");
                items.push("- Gunakan transportasi umum lebih sering.");
                items.push("- Berjalan kaki atau bersepeda untuk jarak dekat.");
                items.push("- Pertimbangkan untuk carpooling atau berbagi kendaraan.");
                items.push("- Rawat kendaraan Anda agar efisien bahan bakar.");
                items.push("- Jika memungkinkan, pertimbangkan kendaraan listrik atau hibrida.");
            }

            if (breakdown.sampah > 0) {
                items.push("Fokus pada pengelolaan sampah yang lebih baik:");
                items.push("- Kurangi penggunaan produk sekali pakai, terutama plastik.");
                items.push("- Daur ulang sampah anorganik (plastik, kertas, logam, kaca).");
                items.push("- Kompos sampah organik untuk pupuk.");
                items.push("- Beli produk dengan kemasan minimal atau dapat didaur ulang.");
                items.push("- Perbaiki barang yang rusak daripada langsung membuangnya.");
            }

            if (breakdown.makanan > 0) {
                items.push("Fokus pada pola makan yang lebih berkelanjutan:");
                items.push("- Kurangi konsumsi daging merah dan produk susu.");
                items.push("- Tingkatkan konsumsi makanan nabati, seperti sayuran, buah-buahan, dan biji-bijian.");
                items.push("- Beli makanan lokal dan musiman untuk mengurangi jejak transportasi.");
                items.push("- Hindari membuang-buang makanan.");
                items.push("- Pertimbangkan untuk menanam makanan Anda sendiri jika memungkinkan.");
            }

            // Jika tidak ada saran spesifik yang ditambahkan (misalnya semua emisi nol), tambahkan saran umum
            if (items.length === 0) {
                items.push("Secara umum, Anda bisa:");
                items.push("- Hemat energi di rumah dan tempat kerja.");
                items.push("- Pilih transportasi yang lebih ramah lingkungan.");
                items.push("- Kurangi dan daur ulang sampah Anda.");
                items.push("- Adopsi pola makan yang lebih berkelanjutan.");
                items.push("- Dukung energi terbarukan dan inisiatif hijau di komunitas Anda.");
            }
            
            return { intro: intro, items: items, outro: outro };
        };

        // Fungsi untuk menghitung emisi
        const calculateEmissions = () => {
            let electricityEmissionsDaily = 0;
            let transportEmissionsDaily = 0;
            let wasteEmissionsDaily = 0;
            let dietEmissionsDaily = 0;

            // Hitung emisi listrik (bulanan ke harian)
            if (electricityKWh) {
                electricityEmissionsDaily = (parseFloat(electricityKWh) / 30) * EMISSION_FACTORS.electricity;
            }

            // Hitung emisi transportasi (bulanan ke harian)
            if (transportKm) {
                const distance = parseFloat(transportKm);
                switch (vehicleType) {
                    case 'mobil':
                        transportEmissionsDaily = (distance / 30) * EMISSION_FACTORS.car; // Convert monthly km to daily km
                        break;
                    case 'motor':
                        transportEmissionsDaily = (distance / 30) * EMISSION_FACTORS.motorcycle; // Convert monthly km to daily km
                        break;
                    case 'umum':
                        transportEmissionsDaily = (distance / 30) * EMISSION_FACTORS.publicTransport; // Convert monthly km to daily km
                        break;
                    case 'sepeda/jalan kaki':
                        transportEmissionsDaily = 0;
                        break;
                    default:
                        break;
                }
            }

            // Hitung emisi sampah (mingguan ke harian)
            // wasteKg adalah "Sampah Dihasilkan Mingguan (kg)"
            if (wasteKg) {
                wasteEmissionsDaily = (parseFloat(wasteKg) / 7) * EMISSION_FACTORS.waste; // Convert weekly kg to daily kg
            }

            // Hitung emisi diet (bulanan ke harian)
            dietEmissionsDaily = (EMISSION_FACTORS.diet[dietType] || 0) / 30; // Convert monthly diet factor to daily

            const totalDaily = electricityEmissionsDaily + transportEmissionsDaily + wasteEmissionsDaily + dietEmissionsDaily;

            totalEmissions = totalDaily; // totalEmissions sekarang adalah harian
            emissionBreakdown = {
                listrik: electricityEmissionsDaily,
                transportasi: transportEmissionsDaily,
                sampah: wasteEmissionsDaily,
                makanan: dietEmissionsDaily,
            };

            // Hitung ekuivalen pohon (kembali ke basis tahunan yang lebih logis)
            const annualEmissionsFromDaily = totalDaily * 365; // Total emisi dalam setahun
            treesEquivalent = annualEmissionsFromDaily / CO2_PER_TREE_PER_YEAR; // Jumlah pohon yang dibutuhkan per tahun
            // Bulatkan ke atas karena Anda tidak bisa menanam sebagian pohon.
            treesEquivalent = Math.ceil(treesEquivalent);
            // Pastikan minimal 0 pohon jika emisi 0 atau negatif
            if (treesEquivalent < 0) treesEquivalent = 0;


            // Set static suggestions based on new breakdown
            staticSuggestions = getStaticSuggestions(emissionBreakdown);
            updateUI(); // Perbarui UI setelah perhitungan
            playSound('sounds/success.mp3'); // Mainkan suara sukses
        };

        // Fungsi untuk mengatur ulang semua input dan hasil
        const resetCalculator = () => {
            electricityKWh = 0; // Reset ke 0
            vehicleType = 'mobil';
            transportKm = 0; // Reset ke 0
            wasteKg = 0; // Reset ke 0
            dietType = 'daging';
            totalEmissions = 0;
            emissionBreakdown = {};
            treesEquivalent = 0;
            staticSuggestions = { intro: "", items: [], outro: "" }; // Reset static suggestions
            updateUI(); // Perbarui UI setelah reset
            playSound('sounds/reset.mp3'); // Mainkan suara reset
        };

        // Placeholder for saving data to Firestore (future enhancement)
        const saveData = async () => {
            if (!db || !userId || !isAuthReady) {
                console.warn("Firebase not ready or user not authenticated. Cannot save data.");
                return;
            }
            try {
                const dataToSave = {
                    electricityKWh,
                    vehicleType,
                    transportKm,
                    wasteKg,
                    dietType,
                    totalEmissions,
                    emissionBreakdown,
                    treesEquivalent,
                    timestamp: new Date().toISOString(),
                };
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/carbonCalculations`, `calc-${Date.now()}`);
                await setDoc(docRef, dataToSave);
                console.log("Data saved successfully!");
            } catch (error) {
                console.error("Error saving data to Firestore:", error);
            }
        };

        // Fungsi untuk melampirkan event listeners secara programatis
        function attachEventListeners() {
            document.getElementById('electricity')?.addEventListener('change', (e) => { electricityKWh = parseFloat(e.target.value) || 0; updateUI(); });
            document.getElementById('transportKm')?.addEventListener('change', (e) => { transportKm = parseFloat(e.target.value) || 0; updateUI(); });
            document.getElementById('vehicleType')?.addEventListener('change', (e) => { vehicleType = e.target.value; updateUI(); });
            document.getElementById('waste')?.addEventListener('change', (e) => { wasteKg = parseFloat(e.target.value) || 0; updateUI(); });
            document.getElementById('diet')?.addEventListener('change', (e) => { dietType = e.target.value; updateUI(); });

            document.getElementById('calculateButton')?.addEventListener('click', calculateEmissions);
            document.getElementById('resetButton')?.addEventListener('click', resetCalculator);
            document.getElementById('infoButton')?.addEventListener('click', () => {
                showInfoModal = true;
                updateUI();
                playSound('sounds/info_pop.mp3');
            });
            document.getElementById('backToHomeButton')?.addEventListener('click', () => {
                window.location.href = 'index.html';
                playSound('sounds/button_click.mp3'); // Suara saat kembali ke beranda
            });
            document.getElementById('toggleDarkModeButton')?.addEventListener('click', toggleDarkMode); // Event listener untuk dark mode

            // Event listener untuk tombol "Lihat Saran"
            document.getElementById('showSuggestionsButton')?.addEventListener('click', () => {
                showSuggestionsModal = true;
                updateUI();
                playSound('sounds/info_pop.mp3'); // Bisa gunakan suara yang sama atau berbeda
            });

            // Modal close buttons
            document.getElementById('modalCloseButton')?.addEventListener('click', () => {
                showInfoModal = false;
                updateUI();
                playSound('sounds/info_close.mp3');
            });
            document.getElementById('modalOverlayCloseButton')?.addEventListener('click', () => {
                showInfoModal = false;
                updateUI();
                playSound('sounds/info_close.mp3');
            });
            // Modal saran close buttons
            document.getElementById('suggestionsModalCloseButton')?.addEventListener('click', () => {
                showSuggestionsModal = false;
                updateUI();
                playSound('sounds/info_close.mp3');
            });
            document.getElementById('suggestionsModalOverlayCloseButton')?.addEventListener('click', () => {
                showSuggestionsModal = false;
                updateUI();
                playSound('sounds/info_close.mp3');
            });
        }

        // Fungsi untuk memperbarui UI berdasarkan state
        function updateUI() {
            // Muat state mode gelap dari localStorage saat pertama kali memuat UI
            const savedDarkMode = localStorage.getItem('isDarkMode');
            if (savedDarkMode !== null) {
                isDarkMode = JSON.parse(savedDarkMode);
            }

            // Tentukan kelas CSS berdasarkan mode gelap/terang
            const bodyBgClass = isDarkMode ? 'bg-gradient-to-br from-gray-950 to-gray-800' : 'bg-gradient-to-br from-emerald-50 to-blue-100';
            const cardBgClass = isDarkMode ? 'bg-gray-800' : 'bg-white';
            const textColorClass = isDarkMode ? 'text-gray-100' : 'text-gray-700';
            const subTextColorClass = isDarkMode ? 'text-gray-400' : 'text-gray-600';
            const inputBgClass = isDarkMode ? 'bg-gray-700 text-white' : 'bg-white text-gray-800';
            const inputBorderClass = isDarkMode ? 'border-gray-600' : 'border-gray-300';
            const resultBgClass = isDarkMode ? 'bg-gray-700 border-gray-600' : 'bg-green-50 border-green-200';
            const resultTextColorClass = isDarkMode ? 'text-gray-100' : 'text-green-800';
            const resultValueColorClass = isDarkMode ? 'text-emerald-300' : 'text-green-900';
            const breakdownBgClass = isDarkMode ? 'bg-gray-700' : 'bg-white';
            const breakdownTextColorClass = isDarkMode ? 'text-gray-200' : 'text-gray-700';
            const breakdownValueColorClass = isDarkMode ? 'text-emerald-300' : 'text-green-600';
            const treeBgClass = isDarkMode ? 'bg-gray-700 border-gray-600' : 'bg-green-100 border-green-300';
            const treeTextColorClass = isDarkMode ? 'text-gray-100' : 'text-green-800';
            const treeValueColorClass = isDarkMode ? 'text-emerald-300' : 'text-green-900';
            const suggestionBgClass = isDarkMode ? 'bg-gray-600 border-gray-500' : 'bg-purple-50 border-purple-200';
            const suggestionTextColorClass = isDarkMode ? 'text-gray-200' : 'text-gray-800';
            const modalBgClass = isDarkMode ? 'bg-gray-800' : 'bg-white';
            const modalTextColorClass = isDarkMode ? 'text-gray-200' : 'text-gray-800';
            const modalListColorClass = isDarkMode ? 'text-gray-400' : 'text-gray-600';

            // Terapkan kelas latar belakang langsung ke elemen body
            const bodyElement = document.body;
            bodyElement.className = `flex items-center justify-center min-h-screen p-4 ${bodyBgClass}`;

            const appHtml = `
                <div class="${cardBgClass} p-6 rounded-2xl shadow-xl w-full max-w-2xl transform transition-all duration-300 hover:scale-[1.01] border ${isDarkMode ? 'border-gray-700' : 'border-gray-200'}">
                    <div class="flex items-center justify-between mb-6">
                        <h1 class="text-3xl sm:text-4xl font-extrabold ${isDarkMode ? 'text-emerald-400' : 'text-green-700'} drop-shadow-sm">
                            JejakKu
                        </h1>
                        <button id="toggleDarkModeButton" class="relative inline-flex items-center h-8 w-16 rounded-full transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-purple-500 ${isDarkMode ? 'bg-gray-700' : 'bg-green-500'}">
                            <span class="sr-only">Toggle dark mode</span>
                            <!-- Sun Icon -->
                            <svg class="absolute left-1 top-1 w-6 h-6 text-yellow-400 transition-opacity duration-300 ${isDarkMode ? 'opacity-0' : 'opacity-100'}" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 17a5 5 0 1 0 0-10 5 5 0 0 0 0 10zm0 2a7 7 0 1 1 0-14 7 7 0 0 1 0 14zm0-12a1 1 0 0 1 1-1h2a1 1 0 0 1 0 2h-2a1 1 0 0 1-1-1zm0 10a1 1 0 0 1 1-1h2a1 1 0 0 1 0 2h-2a1 1 0 0 1-1-1zm6.364-10.364a1 1 0 0 1 0-1.414l1.414-1.414a1 1 0 0 1 1.414 0 1 1 0 0 1 0 1.414l-1.414 1.414a1 1 0 0 1-1.414 0zM5.636 18.364a1 1 0 0 1 0 1.414l-1.414 1.414a1 1 0 0 1-1.414 0 1 1 0 0 1 0-1.414l1.414-1.414a1 1 0 0 1 1.414 0zM12 0a1 1 0 0 1 1-1h2a1 1 0 0 1 0 2h-2a1 1 0 0 1-1-1zm0 24a1 1 0 0 1 1-1h2a1 1 0 0 1 0 2h-2a1 1 0 0 1-1-1zm-6.364-10.364a1 1 0 0 1 0-1.414l-1.414-1.414a1 1 0 0 1-1.414 0 1 1 0 0 1 0 1.414l1.414 1.414a1 1 0 0 1 1.414 0zM18.364 5.636a1 1 0 0 1 0 1.414l1.414 1.414a1 1 0 0 1 1.414 0 1 1 0 0 1 0-1.414l-1.414-1.414a1 1 0 0 1-1.414 0z"/>
                            </svg>
                            <!-- Moon Icon -->
                            <svg class="absolute right-1 top-1 w-6 h-6 text-blue-300 transition-opacity duration-300 ${isDarkMode ? 'opacity-100' : 'opacity-0'}" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2.25a9.75 9.75 0 0 0-9.75 9.75c0 5.385 4.365 9.75 9.75 9.75a9.75 9.75 0 0 0 9.75-9.75c0-5.385-4.365-9.75-9.75-9.75zm-6.25 9.75a6.25 6.25 0 0 1 6.25-6.25v12.5a6.25 6.25 0 0 1-6.25-6.25z"/>
                            </svg>
                            <!-- Thumb -->
                            <span class="absolute left-1 w-6 h-6 bg-white rounded-full shadow-md transform transition-transform duration-300 ${isDarkMode ? 'translate-x-8' : 'translate-x-0'}"></span>
                        </button>
                    </div>
                    <img src="sounds/maskot.png" alt="Maskot JejakKu" class="w-24 h-24 mx-auto mb-6 rounded-full shadow-lg border-2 ${isDarkMode ? 'border-gray-600' : 'border-green-300'}">
                    <p class="text-center ${subTextColorClass} mb-8">
                        Hitung perkiraan emisi karbon Anda dan temukan cara untuk berkontribusi pada Indonesia bebas emisi!
                    </p>

                    ${userId && isAuthReady ? `
                        <div class="text-sm ${subTextColorClass} text-center mb-4 p-2 ${isDarkMode ? 'bg-gray-700' : 'bg-gray-50'} rounded-lg">
                            ID Pengguna Anda: <span class="font-mono break-all">${userId}</span>
                        </div>
                    ` : ''}

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <!-- Electricity Input -->
                        <div class="flex flex-col">
                            <label for="electricity" class="text-lg font-semibold ${textColorClass} mb-2">
                                Konsumsi Listrik Bulanan (kWh):
                            </label>
                            <input
                                type="number"
                                id="electricity"
                                class="p-3 border ${inputBorderClass} rounded-lg shadow-md focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 ${inputBgClass} w-full"
                                placeholder="Contoh: 200"
                                value="${electricityKWh}"
                                onchange="electricityKWh = parseFloat(this.value) || 0; updateUI();"
                            />
                        </div>

                        <!-- Transportation Input -->
                        <div class="flex flex-col">
                            <label for="transportKm" class="text-lg font-semibold ${textColorClass} mb-2">
                                Jarak Tempuh Transportasi Bulanan (km):
                            </label>
                            <input
                                type="number"
                                id="transportKm"
                                class="p-3 border ${inputBorderClass} rounded-lg shadow-md focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 ${inputBgClass} w-full"
                                placeholder="Contoh: 500"
                                value="${transportKm}"
                                onchange="transportKm = parseFloat(this.value) || 0; updateUI();"
                            />
                            <label for="vehicleType" class="text-sm ${subTextColorClass} mt-2 mb-1">
                                Jenis Kendaraan:
                            </label>
                            <select
                                id="vehicleType"
                                class="p-3 border ${inputBorderClass} rounded-lg shadow-md focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 ${inputBgClass} w-full"
                                onchange="vehicleType = this.value; updateUI();"
                            >
                                <option value="mobil" ${vehicleType === 'mobil' ? 'selected' : ''}>Mobil Pribadi</option>
                                <option value="motor" ${vehicleType === 'motor' ? 'selected' : ''}>Motor Pribadi</option>
                                <option value="umum" ${vehicleType === 'umum' ? 'selected' : ''}>Transportasi Umum</option>
                                <option value="sepeda/jalan kaki" ${vehicleType === 'sepeda/jalan kaki' ? 'selected' : ''}>Sepeda/Jalan Kencang</option>
                            </select>
                        </div>

                        <!-- Waste Input -->
                        <div class="flex flex-col">
                            <label for="waste" class="text-lg font-semibold ${textColorClass} mb-2">
                                Sampah Dihasilkan Mingguan (kg):
                            </label>
                            <input
                                type="number"
                                id="waste"
                                class="p-3 border ${inputBorderClass} rounded-lg shadow-md focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 ${inputBgClass} w-full"
                                placeholder="Contoh: 5"
                                value="${wasteKg}"
                                onchange="wasteKg = parseFloat(this.value) || 0; updateUI();"
                            />
                        </div>

                        <!-- Diet Input -->
                        <div class="flex flex-col">
                            <label for="diet" class="text-lg font-semibold ${textColorClass} mb-2">
                                Pola Makan:
                            </label>
                            <select
                                id="diet"
                                class="p-3 border ${inputBorderClass} rounded-lg shadow-md focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 ${inputBgClass} w-full"
                                onchange="dietType = this.value; updateUI();"
                            >
                                <option value="daging" ${dietType === 'daging' ? 'selected' : ''}>Pemakan Daging (tinggi)</option>
                                <option value="vegetarian" ${dietType === 'vegetarian' ? 'selected' : ''}>Vegetarian</option>
                                <option value="vegan" ${dietType === 'vegan' ? 'selected' : ''}>Vegan</option>
                            </select>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-col sm:flex-row gap-4 justify-center mb-8">
                        <button
                            id="calculateButton"
                            class="flex-1 bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75"
                        >
                            Hitung Emisi
                        </button>
                        <button
                            id="resetButton"
                            class="flex-1 bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-lg shadow-md hover:bg-gray-400 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75"
                        >
                            Reset
                        </button>
                        <button
                            id="infoButton"
                            class="flex-1 bg-blue-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75"
                        >
                            Tentang Faktor Emisi
                        </button>
                        <button
                            id="backToHomeButton"
                            class="flex-1 bg-purple-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-purple-600 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-400 focus:ring-opacity-75"
                        >
                            Kembali ke Beranda
                        </button>
                    </div>

                    <!-- Results Display -->
                    ${totalEmissions > 0 ? `
                        <div class="${resultBgClass} p-6 rounded-xl border shadow-inner">
                            <h2 class="text-2xl font-bold ${resultTextColorClass} mb-4 text-center">
                                Perkiraan Jejak Karbon Anda:
                            </h2>
                            <p class="text-5xl font-extrabold text-center ${resultValueColorClass} mb-6">
                                ${totalEmissions.toFixed(2)} kg CO2e/hari
                            </p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 ${breakdownTextColorClass}">
                                ${Object.entries(emissionBreakdown).map(([category, value]) => `
                                    <div class="flex justify-between items-center ${breakdownBgClass} p-3 rounded-lg shadow-sm">
                                        <span class="font-medium capitalize">${category}:</span>
                                        <span class="font-semibold ${breakdownValueColorClass}">${value.toFixed(2)} kg CO2e</span>
                                    </div>
                                `).join('')}
                            </div>

                            <!-- Trees Equivalent Display -->
                            <div class="mt-8 text-center ${treeBgClass} p-4 rounded-lg border">
                                <p class="text-lg font-semibold ${treeTextColorClass}">
                                    Untuk mengimbangi emisi tahunan Anda, Anda perlu menanam sekitar:
                                </p>
                                <p class="text-4xl font-extrabold ${treeValueColorClass} mt-2">
                                    ${treesEquivalent} pohon setiap tahun
                                </p>
                                <p class="text-sm ${subTextColorClass} mt-2">
                                    (Estimasi berdasarkan 1 pohon dewasa menyerap sekitar ${CO2_PER_TREE_PER_YEAR.toFixed(0)} kg CO2 per tahun)
                                </p>
                            </div>

                            <p class="text-center ${subTextColorClass} mt-6 text-sm">
                                *Angka ini adalah perkiraan berdasarkan faktor emisi standar. Hasil sebenarnya dapat bervariasi.
                            </p>

                            <!-- Button to show suggestions in a modal -->
                            <div class="mt-8 pt-6 border-t ${isDarkMode ? 'border-gray-700' : 'border-gray-200'} text-center">
                                <button
                                    id="showSuggestionsButton"
                                    class="bg-purple-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-purple-700 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75"
                                >
                                    Lihat Saran Personalisasi
                                </button>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Info Modal -->
                    ${showInfoModal ? `
                        <div class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 modal-overlay">
                            <div class="${modalBgClass} p-8 rounded-xl shadow-2xl max-w-md w-full relative modal-content">
                                <h3 class="text-2xl font-bold ${modalTextColorClass} mb-4">Tentang Faktor Emisi</h3>
                                <p class="${modalTextColorClass} mb-4">
                                    Kalkulator ini menggunakan faktor emisi perkiraan untuk menghitung jejak karbon Anda. Faktor-faktor ini adalah nilai rata-rata global atau contoh dan mungkin tidak secara akurat mencerminkan kondisi spesifik di Indonesia atau kebiasaan pribadi Anda.
                                </p>
                                <ul class="list-disc list-inside ${modalListColorClass} mb-4">
                                    <li>Listrik: Emisi per kWh sangat bervariasi tergantung sumber energi (batu bara, gas, terbarukan).</li>
                                    <li>Transportasi: Emisi per km tergantung pada efisiensi bahan bakar kendaraan, jenis bahan bakar, dan kondisi lalu lintas.</li>
                                    <li>Sampah: Emisi dari sampah bergantung pada metode pengelolaannya (TPA, daur ulang, kompos).</li>
                                    <li>Makanan: Jejak karbon makanan sangat dipengaruhi oleh jenis makanan (daging vs. nabati), produksi, dan transportasi.</li>
                                </ul>
                                <p class="${modalTextColorClass} mb-6">
                                    Untuk hasil yang lebih akurat, disarankan untuk mencari data faktor emisi yang lebih spesifik untuk wilayah Anda.
                                </p>
                                <button
                                    id="modalCloseButton"
                                    class="absolute top-4 right-4 ${isDarkMode ? 'text-gray-400' : 'text-gray-500'} hover:${isDarkMode ? 'text-gray-200' : 'text-gray-700'} text-3xl font-bold"
                                >
                                    &times;
                                </button>
                                <button
                                    id="modalOverlayCloseButton"
                                    class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition-all duration-300"
                                >
                                    Tutup
                                </button>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Suggestions Modal -->
                    ${showSuggestionsModal ? `
                        <div class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 modal-overlay">
                            <div class="${modalBgClass} p-8 rounded-xl shadow-2xl max-w-md w-full relative modal-content">
                                <h3 class="text-2xl font-bold ${modalTextColorClass} mb-4 text-center">
                                    Saran Personalisasi untuk Anda
                                </h3>
                                ${staticSuggestions.items.length > 0 ? `
                                    <p class="${modalTextColorClass} text-base mb-4">${staticSuggestions.intro}</p>
                                    <ul class="list-disc list-inside ${modalListColorClass} text-base space-y-2">
                                        ${staticSuggestions.items.map((item, index) => `
                                            <li key="${index}" class="${item.startsWith('-') ? 'ml-4' : ''}">${item.replace(/^- /, '')}</li>
                                        `).join('')}
                                    </ul>
                                    <p class="${modalTextColorClass} text-base mt-4 text-center font-semibold">${staticSuggestions.outro}</p>
                                ` : `
                                    <p class="${modalTextColorClass} text-center">Hitung jejak karbon Anda untuk mendapatkan saran personalisasi!</p>
                                `}
                                <button
                                    id="suggestionsModalCloseButton"
                                    class="absolute top-4 right-4 ${isDarkMode ? 'text-gray-400' : 'text-gray-500'} hover:${isDarkMode ? 'text-gray-200' : 'text-gray-700'} text-3xl font-bold"
                                >
                                    &times;
                                </button>
                                <button
                                    id="suggestionsModalOverlayCloseButton"
                                    class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition-all duration-300 mt-6"
                                >
                                    Tutup
                                </button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            render(appHtml);
        }

        // Inisialisasi Firebase dan tangani otentikasi
        window.onload = async () => {
            // Muat state mode gelap dari localStorage saat pertama kali memuat UI
            const savedDarkMode = localStorage.getItem('isDarkMode');
            if (savedDarkMode !== null) {
                isDarkMode = JSON.parse(savedDarkMode);
            }
            updateUI(); // Render UI awal

            try {
                // Dapatkan ID aplikasi dan konfigurasi Firebase dari variabel global
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

                // Inisialisasi aplikasi Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Dengarkan perubahan status otentikasi
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                                userId = auth.currentUser?.uid;
                            } else {
                                await signInAnonymously(auth);
                                userId = auth.currentUser?.uid || crypto.randomUUID();
                            }
                        } catch (error) {
                            console.error("Error selama masuk Firebase:", error);
                            userId = crypto.randomUUID();
                        }
                    }
                    isAuthReady = true;
                    updateUI(); // Perbarui UI setelah otentikasi siap
                });
            } catch (error) {
                console.error("Gagal menginisialisasi Firebase:", error);
                userId = crypto.randomUUID();
                isAuthReady = true;
                updateUI();
            }
        };

        // Panggil updateUI pertama kali untuk merender kalkulator
        // updateUI(); // Dihapus karena sudah dipanggil di window.onload
    </script>
</body>
</html>
